name: Workflow to run first jenkins job

on:
  workflow_dispatch:
    inputs:
      Environment:
        description: 'Specify the environment'
        required: true
        type: string
        default: ''
      stack_name:
        description: 'Specify the stack_name'
        required: true
        type: string
        default: ''
      SWAGGER_BRANCH_TAG:
        description: 'Specify the swagger_branch_tag'
        required: true
        type: string
        default: 'master'
      AGENT:
        description: 'Specify the agent'
        required: true
        default: 'master'
        type: choice
        options:
        - ecs
        - master
        - UI_Docker
        - prod_node
        - any

jobs:
  set-agent:
    runs-on: ubuntu-latest # here you have to change as per your actual runners
    outputs:
      selected-agent: ${{ steps.set-agent.outputs.agent }}
    steps:
      - name: Set Agent
        id: set-agent
        run: |
          if [[ "${{ github.event.inputs.AGENT }}" == "any" ]]; then
            echo "agent=ubuntu-latest" >> $GITHUB_ENV
            echo "::set-output name=agent::ubuntu-latest"
          else
            echo "agent=${{ github.event.inputs.AGENT }}" >> $GITHUB_ENV
            echo "::set-output name=agent::${{ github.event.inputs.AGENT }}"
          fi
          echo "The agent chosen: ${{ steps.set-agent.outputs.agent }}" 
    
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Copying Swagger
        id: trigger_deployment
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/second-job.yml/dispatches \
            -d '{
                  "ref": "main",
                  "inputs": {
                    "deploy_env": "${{ github.event.inputs.Environment }}",
                    "stack_name": "${{ github.event.inputs.stack_name }}",
                    "SWAGGER_BRANCH_TAG": "${{ github.event.inputs.SWAGGER_BRANCH_TAG }}",
                    "AGENT": "${{ github.event.inputs.AGENT }}"
                  }
                }'
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}

      - name: Print Result
        run: echo "Triggered deployment workflow"
